apiVersion: v1
kind: Pod
metadata:
  name: reverseproxy-pod
spec:
  tolerations:
    - key: node-role.kubernetes.io/control-plane
      operator: Exists
      effect: NoSchedule
    - key: node.kubernetes.io/disk-pressure
      operator: Exists
      effect: NoSchedule
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
          - matchExpressions:
              - key: node-role.kubernetes.io/control-plane
                operator: Exists
  containers:
    - name: reverseproxy
      image: daafonsecato/kataterm-reverseproxy:v2
      ports:
        - containerPort: 7070
        - containerPort: 9090
      env:
        - name: POSTGRES_HOST
          value: postgres
      volumeMounts:
        - name: reverseproxy-volume
          mountPath: /app
  volumes:
    - name: reverseproxy-volume
      hostPath:
        path: /home/ubuntu/kataterm/reverseproxy
---
apiVersion: v1
kind: Service
metadata:
  name: reverseproxy-service
spec:
  type: NodePort
  selector:
    app: reverseproxy-pod
  ports:
    - name: reverseproxy
      protocol: TCP
      port: 7070
      targetPort: 7070
      nodePort: 30007
    - name: labmanager
      protocol: TCP
      port: 9090
      targetPort: 9090
      nodePort: 30009
